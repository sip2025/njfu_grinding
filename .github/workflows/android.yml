name: Android Build and Release

on:
  push:
    branches: [ "main", "master" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.6'

    - name: Fix Gradle Wrapper
      run: |
        mkdir -p gradle/wrapper
        echo "distributionBase=GRADLE_USER_HOME" > gradle/wrapper/gradle-wrapper.properties
        echo "distributionPath=wrapper/dists" >> gradle/wrapper/gradle-wrapper.properties
        echo "distributionUrl=https\://services.gradle.org/distributions/gradle-8.6-bin.zip" >> gradle/wrapper/gradle-wrapper.properties
        echo "zipStoreBase=GRADLE_USER_HOME" >> gradle/wrapper/gradle-wrapper.properties
        echo "zipStorePath=wrapper/dists" >> gradle/wrapper/gradle-wrapper.properties
        
        # Download wrapper jar if missing
        if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
            curl -L https://raw.githubusercontent.com/gradle/gradle/v8.6.0/gradle/wrapper/gradle-wrapper.jar -o gradle/wrapper/gradle-wrapper.jar
        fi

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Generate Release Keystore
      run: |
        keytool -genkey -v -keystore app/release.keystore -storepass android -alias androidreleasekey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Release,O=Android,C=US"

    - name: Build Release APKs (All Architectures)
      run: ./gradlew assembleRelease

    - name: Rename APK files with version info
      run: |
        cd app/build/outputs/apk/release
        # Ensure all APKs are in the root of the release directory (handle subdirectories created by splits)
        find . -mindepth 2 -type f -name "*.apk" -exec mv {} . \;
        
        for file in *.apk; do
          if [[ "$file" == *"universal"* ]]; then
            mv "$file" "NJFU-grinding-universal-release.apk"
          elif [[ "$file" == *"armeabi-v7a"* ]]; then
            mv "$file" "NJFU-grinding-armeabi-v7a-release.apk"
          elif [[ "$file" == *"arm64-v8a"* ]]; then
            mv "$file" "NJFU-grinding-arm64-v8a-release.apk"
          elif [[ "$file" == *"x86_64"* ]]; then
            mv "$file" "NJFU-grinding-x86_64-release.apk"
          elif [[ "$file" == *"x86"* ]] && [[ "$file" != *"x86_64"* ]]; then
            mv "$file" "NJFU-grinding-x86-release.apk"
          fi
        done

    - name: Upload Universal APK
      uses: actions/upload-artifact@v4
      with:
        name: universal-apk
        path: app/build/outputs/apk/release/NJFU-grinding-universal-release.apk
        if-no-files-found: warn

    - name: Upload ARM64-v8a APK
      uses: actions/upload-artifact@v4
      with:
        name: arm64-v8a-apk
        path: app/build/outputs/apk/release/NJFU-grinding-arm64-v8a-release.apk
        if-no-files-found: warn

    - name: Upload ARMv7 APK
      uses: actions/upload-artifact@v4
      with:
        name: armeabi-v7a-apk
        path: app/build/outputs/apk/release/NJFU-grinding-armeabi-v7a-release.apk
        if-no-files-found: warn

    - name: Upload x86_64 APK
      uses: actions/upload-artifact@v4
      with:
        name: x86_64-apk
        path: app/build/outputs/apk/release/NJFU-grinding-x86_64-release.apk
        if-no-files-found: warn

    - name: Upload x86 APK
      uses: actions/upload-artifact@v4
      with:
        name: x86-apk
        path: app/build/outputs/apk/release/NJFU-grinding-x86-release.apk
        if-no-files-found: warn

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: apk-artifacts

    - name: Display structure of downloaded files
      run: ls -R apk-artifacts

    - name: Extract version info
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Create Release Notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## NJFUåˆ·é¢˜åŠ©æ‰‹ v${{ steps.version.outputs.version }}
        
        ### ðŸ“¦ å¤šæž¶æž„æ”¯æŒ
        
        æœ¬æ¬¡å‘å¸ƒæä¾›ä»¥ä¸‹ç‰ˆæœ¬ï¼Œè¯·æ ¹æ®æ‚¨çš„è®¾å¤‡é€‰æ‹©åˆé€‚çš„APKï¼š
        
        - **Universal APK (é€šç”¨ç‰ˆ)** - åŒ…å«æ‰€æœ‰æž¶æž„ï¼Œä½“ç§¯è¾ƒå¤§ä½†å…¼å®¹æ€§æœ€å¥½ï¼ŒæŽ¨èå¤§å¤šæ•°ç”¨æˆ·ä¸‹è½½
        - **ARM64-v8a** - é€‚ç”¨äºŽå¤§å¤šæ•°çŽ°ä»£ Android è®¾å¤‡ï¼ˆ2015å¹´åŽçš„å¤§éƒ¨åˆ†æ‰‹æœºï¼‰
        - **ARMv7** - é€‚ç”¨äºŽè¾ƒè€çš„ 32ä½ ARM è®¾å¤‡
        - **x86_64** - é€‚ç”¨äºŽ64ä½ x86 Android è®¾å¤‡ï¼ˆå¦‚æ¨¡æ‹Ÿå™¨ï¼‰
        - **x86** - é€‚ç”¨äºŽ32ä½ x86 Android è®¾å¤‡
        
        ### å¦‚ä½•é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ï¼Ÿ
        
        1. **ä¸ç¡®å®šé€‰å“ªä¸ªï¼Ÿ** â†’ ä¸‹è½½ Universal APK
        2. **æƒ³è¦æœ€å°ä½“ç§¯ï¼Ÿ** â†’ æ ¹æ®è®¾å¤‡æž¶æž„é€‰æ‹©å¯¹åº”ç‰ˆæœ¬
        3. **2015å¹´åŽçš„æ‰‹æœº** â†’ é€šå¸¸é€‰æ‹© ARM64-v8a
        4. **æ¨¡æ‹Ÿå™¨/x86è®¾å¤‡** â†’ é€‰æ‹© x86_64 æˆ– x86
        
        ### âœ¨ æ›´æ–°å†…å®¹
        
        - æ”¯æŒå¤šæž¶æž„æž„å»ºï¼Œä¼˜åŒ–ä¸åŒè®¾å¤‡çš„æ€§èƒ½å’Œä½“ç§¯
        - è‡ªåŠ¨åŒ– GitHub Actions æž„å»ºå’Œå‘å¸ƒæµç¨‹
        
        ---
        
        ðŸ’¡ æç¤ºï¼šå¦‚æžœæ‚¨ä¸ç¡®å®šè®¾å¤‡æž¶æž„ï¼Œå¯ä»¥ä¸‹è½½ **Universal APK**ï¼Œå®ƒèƒ½åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šè¿è¡Œã€‚
        EOF
        cat release_notes.md

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: NJFUåˆ·é¢˜åŠ©æ‰‹ v${{ steps.version.outputs.version }}
        body_path: release_notes.md
        files: |
          apk-artifacts/universal-apk/*.apk
          apk-artifacts/arm64-v8a-apk/*.apk
          apk-artifacts/armeabi-v7a-apk/*.apk
          apk-artifacts/x86_64-apk/*.apk
          apk-artifacts/x86-apk/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
